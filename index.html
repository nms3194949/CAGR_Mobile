<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>雙贏策略｜手機版配息試算＋投組分析</title>
<style>
/* ====== 行動優先（iPhone 15 Pro 基準 393px） ====== */
:root{
  --deep:#0A1221; --gold:#C9A227; --gold-soft:#E9D18A;
  --card:#0C152A; --pos:#39C27A; --neg:#E25A5A;
  --field:#101b33; --input:#071226; --line:rgba(233,209,138,.25);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--deep);color:#fff;font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,sans-serif}
.wrap{max-width:540px;margin:0 auto;padding:12px 12px 80px}

/* Header / Tabs */
.header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(10,18,33,.98),rgba(10,18,33,.9));backdrop-filter:blur(6px);padding:10px 12px;border-bottom:1px solid rgba(201,162,39,.25)}
.h1{margin:0;font-size:18px;letter-spacing:.3px;background:linear-gradient(90deg,var(--gold),var(--gold-soft));-webkit-background-clip:text;background-clip:text;color:transparent}
.tabs{display:flex;gap:8px;margin-top:8px}
.tab{flex:1;padding:10px 0;text-align:center;border-radius:10px;border:1px solid rgba(201,162,39,.35);background:#0f1830;color:#E9D18A;font-weight:700}
.tab[aria-selected="true"]{background:linear-gradient(90deg,var(--gold),var(--gold-soft));color:#0A1221;border-color:transparent}

/* Floating Action Bar (Export) */
.fab{position:fixed;left:0;right:0;bottom:0;z-index:20;background:linear-gradient(180deg,rgba(10,18,33,.1),rgba(10,18,33,.9) 30%,rgba(10,18,33,1));padding:8px 12px 14px;border-top:1px solid rgba(201,162,39,.25)}
.actions{display:flex;gap:8px}
.btn{flex:1;padding:12px 14px;border-radius:12px;border:0;cursor:pointer;font-weight:700;color:#0A1221;background:linear-gradient(90deg,var(--gold),var(--gold-soft))}
.btn:active{transform:translateY(1px)}

/* Cards & Panels */
.card{border:1px solid rgba(201,162,39,.35);border-radius:14px;padding:14px;margin:12px 0;background:linear-gradient(180deg,rgba(10,18,33,.95),rgba(10,18,33,.75))}
.title{margin:0 0 6px;font-size:16px;background:linear-gradient(90deg,var(--gold),var(--gold-soft));-webkit-background-clip:text;background-clip:text;color:transparent}
.subtitle{margin:0 0 10px;color:#cfd6e6;font-size:13px;line-height:1.4}

/* Forms */
.grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
.grid-1{grid-template-columns:1fr}
.field{background:var(--field);border:1px solid rgba(201,162,39,.18);border-radius:10px;padding:8px}
.label{display:block;font-size:12px;color:#E9D18A;margin-bottom:6px}
.control{width:100%;height:42px;padding:0 10px;border-radius:9px;border:1px solid rgba(233,209,138,.12);background:var(--input);color:#fff;font-size:15px;outline:none}
input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none}
input[type=number]{-moz-appearance:textfield}

/* Tables → 可滑動 */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:10px;border:1px solid rgba(201,162,39,.25);background:var(--card)}
table{width:100%;border-collapse:collapse;min-width:560px}
th,td{padding:10px 12px;text-align:left;white-space:nowrap}
th{font-size:12px;color:#E9D18A;border-bottom:2px solid rgba(201,162,39,.5);background:rgba(201,162,39,.08)}
td{font-size:14px;color:#f5f5f5;border-bottom:1px solid var(--line)}
.em{font-weight:700;color:#fff}
.pos{color:var(--pos);font-weight:700}
.neg{color:var(--neg);font-weight:700}
.gold{color:var(--gold);font-weight:700}
.muted{color:#b9c2d5;font-size:12px}

/* Panels show/hide */
.tabpanel{display:none}
.tabpanel.active{display:block}

/* Exporting（避免漸層被整塊當圖） */
.exporting .h1,.exporting .title{background:none!important;color:var(--gold)!important;-webkit-text-fill-color:initial!important}
</style>
</head>
<body>
  <!-- Sticky Header -->
  <div class="header">
    <h1 class="h1">雙贏策略｜行動版配息＋投組</h1>
    <div class="tabs" role="tablist" aria-label="試算功能">
      <button class="tab" id="tab-cash" role="tab" aria-controls="panel-cash" aria-selected="true">每月配息</button>
      <button class="tab" id="tab-portfolio" role="tab" aria-controls="panel-portfolio" aria-selected="false">投組分析</button>
    </div>
  </div>

  <div class="wrap">
    <!-- Panel 1：每月配息 -->
    <section id="panel-cash" class="tabpanel active" role="tabpanel" aria-labelledby="tab-cash">
      <div class="card">
        <h2 class="title">每月配息試算</h2>
        <p class="subtitle">年化（含息）≈ [(本金＋融資)×配息率 − 融資×利率] ÷ 本金</p>
        <div class="grid">
          <div class="field"><span class="label">投入本金（$）</span><input id="principal" type="number" class="control" value="1000000"></div>
          <div class="field"><span class="label">融資金額（$）</span><input id="loan" type="number" class="control" value="1500000"></div>
          <div class="field"><span class="label">融資成數</span>
            <select id="ratio" class="control">
              <option value="0|0.0000">0 成</option>
              <option value="0.1|0.1111111111">1 成</option>
              <option value="0.2|0.25">2 成</option>
              <option value="0.3|0.4285714286">3 成</option>
              <option value="0.4|0.6666666667">4 成</option>
              <option value="0.5|1.0">5 成</option>
              <option value="0.6|1.5" selected>6 成</option>
              <option value="custom|custom">自訂</option>
            </select>
          </div>
          <div class="field"><span class="label">年化配息率（%）</span><input id="rate" type="number" class="control" value="10.00" step="0.01"></div>
          <div class="field"><span class="label">融資年利率（%）</span><input id="loanRate" type="number" class="control" value="4.00" step="0.01"></div>
        </div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>項目</th><th>金額 / 比率</th></tr></thead>
            <tbody>
              <tr><td>投入本金</td><td id="vPrincipal">—</td></tr>
              <tr><td>融資成數</td><td id="vRatio">—</td></tr>
              <tr><td>融資金額</td><td id="vLoan">—</td></tr>
              <tr><td>投入總額（本金＋融資）</td><td id="vTotal" class="em">—</td></tr>
              <tr><td>年化配息率</td><td id="vRate">—</td></tr>
              <tr><td>每月配息（估）</td><td id="vMonthlyDiv" class="pos">—</td></tr>
              <tr><td>每月利息支出</td><td id="vMonthlyInt" class="neg">—</td></tr>
              <tr><td>每月淨現金流</td><td id="vMonthlyNet" class="em">—</td></tr>
              <tr><td>預估報酬率（含息，年化）</td><td id="vEstReturn" class="gold">—</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Panel 2：投組分析 -->
    <section id="panel-portfolio" class="tabpanel" role="tabpanel" aria-labelledby="tab-portfolio">
      <div class="card">
        <h2 class="title">投資組合｜1/3/5 年 CAGR 與配息拆解</h2>
        <p class="subtitle">輸入「近1/3/5年累積報酬率(%)」與「配息率(%)、配置(%)」。系統換算 CAGR；資本成長≈CAGR−配息。</p>

        <!-- 工具列（行動簡化：兩列） -->
        <div class="grid">
          <div class="field">
            <span class="label">常用基金清單</span>
            <select id="presetSelect" class="control"><option value="">— 選擇常用基金 —</option></select>
          </div>
          <div class="field">
            <span class="label">帶入到哪一列</span>
            <select id="targetRow" class="control">
              <option value="0">基金A</option><option value="1">基金B</option>
              <option value="2">基金C</option><option value="3">基金D</option>
              <option value="4">基金E</option>
            </select>
          </div>
          <div class="field grid-1" style="grid-column:1/-1">
            <span class="label">帶入數據</span>
            <button class="btn" id="applyPresetBtn">帶入</button>
          </div>
          <div class="field grid-1" style="grid-column:1/-1">
            <span class="label">基金資料庫（Excel）</span>
            <div class="actions">
              <input type="file" id="importXlsx" accept=".xlsx,.xls" style="display:none" />
              <button class="btn" id="btnImportXlsx">匯入 Excel</button>
              <button class="btn" id="btnExportXlsx">匯出 Excel</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="grid-1 grid">
          <div class="field">
            <span class="label">融資年利率（%）— 由《每月配息》同步</span>
            <input id="loanRateMirror" class="control" type="number" step="0.01" value="0" disabled>
          </div>
        </div>
      </div>

      <!-- A~E 輸入表 -->
      <div class="card">
        <div class="table-wrap">
          <table id="fundInputTable">
            <thead>
              <tr>
                <th>基金名稱</th><th>近1年(%)</th><th>近3年累積(%)</th><th>近5年累積(%)</th><th>配息率(%)</th><th>配置(%)</th>
              </tr>
            </thead>
            <tbody>
              <!-- 建議：用手機時每列先填完再滑動下一欄 -->
              ${[...Array(5)].map((_,i)=>`
              <tr>
                <td><input class="control name" type="text" placeholder="基金${String.fromCharCode(65+i)}"></td>
                <td><input class="control fin r1" type="number" step="0.01"></td>
                <td><input class="control fin r3" type="number" step="0.01"></td>
                <td><input class="control fin r5" type="number" step="0.01"></td>
                <td><input class="control fin dy" type="number" step="0.01"></td>
                <td><input class="control fin wt" type="number" step="0.01"></td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>

      <!-- 單檔輸出 -->
      <div class="card">
        <div class="table-wrap">
          <table id="fundOutputTable">
            <thead>
              <tr>
                <th>基金</th><th>CAGR(1Y)</th><th>CAGR(3Y)</th><th>CAGR(5Y)</th>
                <th>CAGR(3Y)−配息</th><th>資本成長(1Y)</th><th>資本成長(3Y)</th><th>資本成長(5Y)</th>
              </tr>
            </thead>
            <tbody id="fundRows"></tbody>
          </table>
        </div>
      </div>

      <!-- 投組匯總 -->
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>投組指標（加權年化）</th><th>1年</th><th>3年</th><th>5年</th></tr></thead>
            <tbody>
              <tr><td>含息報酬（CAGR）</td><td id="pf_cagr1" class="gold">—</td><td id="pf_cagr3" class="gold">—</td><td id="pf_cagr5" class="gold">—</td></tr>
              <tr><td>配息率（加權）</td><td id="pf_div1" class="pos">—</td><td id="pf_div3" class="pos">—</td><td id="pf_div5" class="pos">—</td></tr>
              <tr><td>資本成長（含息−配息）</td><td id="pf_cap1" class="em">—</td><td id="pf_cap3" class="em">—</td><td id="pf_cap5" class="em">—</td></tr>
              <tr><td>融資水位 LTV</td><td id="pf_ltv1" class="em">—</td><td id="pf_ltv3" class="em">—</td><td id="pf_ltv5" class="em">—</td></tr>
            </tbody>
          </table>
        </div>
        <p class="muted" style="margin-top:8px">※ 近3/5年：累積→幾何年化；近1年視同當年。LTV &gt; 80% 會標紅。</p>
      </div>
    </section>

    <p class="muted">⚠️ 本頁僅為試算與教育用途，非投資建議。歷史績效不代表未來表現。</p>
  </div>

  <!-- 浮動匯出 -->
  <div class="fab">
    <div class="actions">
      <button class="btn" id="btnPng">匯出 PNG</button>
      <button class="btn" id="btnPdf">匯出 PDF</button>
    </div>
  </div>

  <!-- 內建預設常用基金（無代碼） -->
  <script id="fundCatalogDefault" type="application/json">
  [
    {"name":"鋒裕匯理基金新興市場債券 A 美元 (穩定月配息)","r1":8.56,"r3":39.91,"r5":15.07,"dy":17.16},
    {"name":"高盛環球非投資等級債券基金X股美元(月配息)","r1":7.96,"r3":35.95,"r5":17.48,"dy":14.31}
  ]
  </script>

  <!-- libs（行動裝置可用；必要時再載入） -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

<script>
/* ========= 小工具 ========= */
const $=id=>document.getElementById(id);
const fmtPct=n=>isFinite(n)?(n*100).toFixed(2)+'%':'—';
const twd=n=>new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',maximumFractionDigits:0}).format(n);
const num=el=>{const v=parseFloat((el.value||'').toString().replace(/,/g,''));return isFinite(v)?v:0;}
function cagrFromTotalPct(totalPct,years){const x=parseFloat(totalPct);if(!isFinite(x))return NaN;const d=x/100;if(d<=-1||years<=0)return NaN;return Math.pow(1+d,1/years)-1;}
function parseRatioValue(val){if(!val||val.startsWith('custom'))return null;const p=val.split('|');return p.length>=2?{ratio:parseFloat(p[0]),mult:parseFloat(p[1])}:null;}
const r2=v=>(v===''||v==null||isNaN(v))?'':Number(v).toFixed(2);

/* ========= Tabs ========= */
const tabs={cash:{tab:$('tab-cash'),panel:$('panel-cash')},pf:{tab:$('tab-portfolio'),panel:$('panel-portfolio')}};
function setTab(key){Object.values(tabs).forEach(o=>{o.tab.setAttribute('aria-selected','false');o.panel.classList.remove('active')});tabs[key].tab.setAttribute('aria-selected','true');tabs[key].panel.classList.add('active');}
tabs.cash.tab.addEventListener('click',()=>setTab('cash'),{passive:true});
tabs.pf.tab.addEventListener('click',()=>setTab('pf'),{passive:true});

/* ========= 常用基金 Catalog（LocalStorage + Excel） ========= */
let FUND_CATALOG=[];
function populatePresetSelect(){
  const sel=$('presetSelect');
  sel.innerHTML=`<option value="">— 選擇常用基金 —</option>`+FUND_CATALOG.map((f,i)=>`<option value="${i}">${f.name}</option>`).join('');
}
function loadCatalog(){
  try{
    const ls=localStorage.getItem('fundCatalog');
    FUND_CATALOG = ls? JSON.parse(ls) : JSON.parse($('fundCatalogDefault').textContent.trim());
  }catch(e){FUND_CATALOG=[]}
  populatePresetSelect();
}
function saveCatalog(){ localStorage.setItem('fundCatalog', JSON.stringify(FUND_CATALOG)); }
function findPresetByIndex(idx){ idx=Number(idx); return Number.isFinite(idx)?(FUND_CATALOG[idx]||null):null; }
function applyPresetToRow(rowIdx, idx){
  const p=findPresetByIndex(idx); if(!p) return alert('找不到該基金');
  const tr=document.querySelectorAll('#fundInputTable tbody tr')[rowIdx]; if(!tr) return;
  tr.querySelector('.name').value=p.name||'';
  tr.querySelector('.r1').value=r2(p.r1);
  tr.querySelector('.r3').value=r2(p.r3);
  tr.querySelector('.r5').value=r2(p.r5);
  tr.querySelector('.dy').value=r2(p.dy);
  recomputePortfolio();
}

/* Excel 匯入/匯出：百分比解析規則（與你原先一致）
   - 純數字/數值：一律 ×100 → 以「百分點」存（1.31→131；0.0856→8.56；-0.05→-5）
   - 結尾含%字串：視為百分點，維持數值（"131%"→131）
*/
const HEADER_MAP={name:['基金名稱','name','基金','名稱'],r1:['近1年%','r1','1Y'],r3:['近3年累積%','r3','3Y'],r5:['近5年累積%','r5','5Y'],dy:['配息率%','dy','Yield%']};
function pick(row,keys){for(const k of keys){if(Object.prototype.hasOwnProperty.call(row,k)&&row[k]!=='')return row[k];}return undefined;}
function parsePercentCell(v){
  if (v===''||v==null) return null;
  if (typeof v==='string'){
    const s=v.trim();
    if (s.endsWith('%')){const n=parseFloat(s.slice(0,-1));return isNaN(n)?null:n;}
    const n=parseFloat(s); return isNaN(n)?null:n*100;
  }
  if (typeof v==='number') return v*100;
  return null;
}
function sheetToCatalog(ws){
  const rows=XLSX.utils.sheet_to_json(ws,{defval:''}), out=[];
  rows.forEach(r=>{
    const item={name:String(pick(r,HEADER_MAP.name)||'').trim(),
      r1:parsePercentCell(pick(r,HEADER_MAP.r1)),
      r3:parsePercentCell(pick(r,HEADER_MAP.r3)),
      r5:parsePercentCell(pick(r,HEADER_MAP.r5)),
      dy:parsePercentCell(pick(r,HEADER_MAP.dy))};
    ['r1','r3','r5','dy'].forEach(k=>{if(item[k]!=null&&isFinite(item[k])) item[k]=Math.round(item[k]*100)/100;});
    if(item.name) out.push(item);
  });
  return out;
}
function catalogToAOA(cat){
  const header=['基金名稱','近1年%','近3年累積%','近5年累積%','配息率%'];
  const n2=v=>(v==null||!isFinite(v))?'':Number(v).toFixed(2);
  const body=cat.map(f=>[f.name||'',n2(f.r1),n2(f.r3),n2(f.r5),n2(f.dy)]);
  return [header,...body];
}
$('btnImportXlsx').addEventListener('click',()=>$('importXlsx').click());
$('importXlsx').addEventListener('change',(e)=>{
  const file=e.target.files[0]; if(!file) return;
  const fr=new FileReader();
  fr.onload=(evt)=>{
    try{
      const wb=XLSX.read(evt.target.result,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]];
      const arr=sheetToCatalog(ws); if(!arr.length) throw new Error('沒有有效資料列');
      FUND_CATALOG=arr; saveCatalog(); populatePresetSelect();
      alert(`Excel 匯入完成：${arr.length} 筆（數字×100；含%維持；四捨五入至小數2位）`);
    }catch(err){ alert('Excel 匯入失敗：'+err.message); }
    e.target.value='';
  };
  fr.readAsArrayBuffer(file);
});
$('btnExportXlsx').addEventListener('click',()=>{
  try{
    const aoa=catalogToAOA(FUND_CATALOG); const ws=XLSX.utils.aoa_to_sheet(aoa); const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'基金清單'); XLSX.writeFile(wb,'fund-catalog.xlsx');
  }catch(err){ alert('Excel 匯出失敗：'+err.message); }
});

/* ========= 投組計算 ========= */
const inputTbody=document.querySelector('#fundInputTable tbody');
const outputBody=$('fundRows');
const defaultNames=['基金A','基金B','基金C','基金D','基金E'];

function readFundRows(){
  return Array.from(inputTbody.querySelectorAll('tr')).map((tr,idx)=>{
    const name=(tr.querySelector('.name')?.value||'').trim()||defaultNames[idx];
    const r1=parseFloat(tr.querySelector('.r1')?.value);
    const r3=parseFloat(tr.querySelector('.r3')?.value);
    const r5=parseFloat(tr.querySelector('.r5')?.value);
    const dy=parseFloat(tr.querySelector('.dy')?.value);
    const wt=parseFloat(tr.querySelector('.wt')?.value);
    return {name,r1,r3,r5,dy,wt};
  });
}
function cagrRow(f){
  const c1=isFinite(f.r1)?(f.r1/100):NaN;
  const c3=isFinite(f.r3)?cagrFromTotalPct(f.r3,3):NaN;
  const c5=isFinite(f.r5)?cagrFromTotalPct(f.r5,5):NaN;
  const dy=isFinite(f.dy)?(f.dy/100):NaN;
  const cap1=(isFinite(c1)&&isFinite(dy))?c1-dy:NaN;
  const cap3=(isFinite(c3)&&isFinite(dy))?c3-dy:NaN;
  const cap5=(isFinite(c5)&&isFinite(dy))?c5-dy:NaN;
  return {c1,c3,c5,dy,cap1,cap3,cap5,diff3:cap3};
}
const spanPct=v=>!isFinite(v)?'—':`<span class="${v<0?'neg':''}">${(v*100).toFixed(2)}%</span>`;
function renderRows(rows){
  outputBody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.name}</td>
      <td>${spanPct(r.c1)}</td>
      <td>${spanPct(r.c3)}</td>
      <td>${spanPct(r.c5)}</td>
      <td>${spanPct(r.diff3)}</td>
      <td>${spanPct(r.cap1)}</td>
      <td>${spanPct(r.cap3)}</td>
      <td>${spanPct(r.cap5)}</td>`;
    outputBody.appendChild(tr);
  });
}
function calcPortfolio(rows){
  const valid=rows.filter(f=>isFinite(f.wt)&&f.wt>0);
  const sumW=valid.reduce((s,f)=>s+f.wt,0);
  const norm=valid.map(f=>({...f,w:(sumW>0?f.wt/sumW:0)}));
  const wAvg=fn=>{let acc=0,ws=0; norm.forEach(f=>{const v=fn(f); if(isFinite(v)){acc+=v*f.w; ws+=f.w;}}); return ws>0?acc:NaN;};

  const c1=wAvg(f=>f.c1), c3=wAvg(f=>f.c3), c5=wAvg(f=>f.c5), dy=wAvg(f=>f.dy);
  const cap1=(isFinite(c1)&&isFinite(dy))?c1-dy:NaN;
  const cap3=(isFinite(c3)&&isFinite(dy))?c3-dy:NaN;
  const cap5=(isFinite(c5)&&isFinite(dy))?c5-dy:NaN;

  $('pf_cagr1').textContent=isFinite(c1)?(c1*100).toFixed(2)+'%':'—';
  $('pf_cagr3').textContent=isFinite(c3)?(c3*100).toFixed(2)+'%':'—';
  $('pf_cagr5').textContent=isFinite(c5)?(c5*100).toFixed(2)+'%':'—';
  const dyTxt=isFinite(dy)?(dy*100).toFixed(2)+'%':'—';
  ['pf_div1','pf_div3','pf_div5'].forEach(id=>$(id).textContent=dyTxt);
  [['pf_cap1',cap1],['pf_cap3',cap3],['pf_cap5',cap5]].forEach(([id,val])=>{
    const el=$(id); el.textContent=isFinite(val)?(val*100).toFixed(2)+'%':'—'; el.classList.toggle('neg',isFinite(val)&&val<0);
  });
  updateLTV(cap1,cap3,cap5);
}

/* 融資水位（單利＋第3年起逐年併入本金） */
function outstandingSeries(P0,r,N=5){
  const B={},I={},O={};
  for(let t=1;t<=N;t++){
    if(t<=2){B[t]=P0;} else {let s=0; for(let k=1;k<=t-2;k++) s+=I[k]; B[t]=P0+s;}
    I[t]=B[t]*r; O[t]=B[t]+I[t]+(t>=2?I[t-1]:0);
  } return {B,I,O};
}
function updateLTV(cap1,cap3,cap5){
  const P=num($('principal')), L=num($('loan'));
  const i=(parseFloat($('loanRate').value)||0)/100;
  const V0=P+L, P0=L, r=i;
  if(!(P0>0&&V0>0)){['pf_ltv1','pf_ltv3','pf_ltv5'].forEach(id=>{ $(id).textContent='—'; $(id).classList.remove('neg');}); return;}
  const {O}=outstandingSeries(P0,r,5);
  const ltv=(g,n)=>{if(!isFinite(g))return NaN;const Vn=V0*Math.pow(1+g,n);return (O[n]/Vn)*100;}
  const l1=ltv(cap1,1), l3=ltv(cap3,3), l5=ltv(cap5,5);
  const fmt=v=>isFinite(v)?v.toFixed(2)+'%':'—';
  $('pf_ltv1').textContent=fmt(l1); $('pf_ltv3').textContent=fmt(l3); $('pf_ltv5').textContent=fmt(l5);
  const paint=(id,v)=>{const el=$(id); el.classList.remove('neg'); if(isFinite(v)&&v>80) el.classList.add('neg');};
  paint('pf_ltv1',l1); paint('pf_ltv3',l3); paint('pf_ltv5',l5);
}
function recomputePortfolio(){
  const raw=readFundRows();
  const calc=raw.map(f=>({...f,...cagrRow(f)}));
  renderRows(calc);
  calcPortfolio(calc);
}

/* ========= 每月配息（自動鏡射到投組） ========= */
const principalEl=$('principal'),loanEl=$('loan'),ratioEl=$('ratio'),rateEl=$('rate'),loanRateEl=$('loanRate');
let autoApplied=true;
function computeCashflow(){
  const P=num(principalEl); let L=num(loanEl);
  const r=parseFloat(rateEl.value)||0; const i=parseFloat(loanRateEl.value)||0;
  const ratioObj=parseRatioValue(ratioEl.value);
  if(ratioObj&&isFinite(ratioObj.mult)){
    const calcLoan=Math.round(P*ratioObj.mult);
    if(autoApplied||num(loanEl)===0||num(loanEl)===calcLoan){ L=calcLoan; loanEl.value=L; autoApplied=true; }
  }
  const total=P+L, annualDiv=total*(r/100), annualInt=L*(i/100);
  const mDiv=annualDiv/12, mInt=annualInt/12, mNet=mDiv-mInt;
  const estReturnPct=(P>0)?((annualDiv-annualInt)/P):NaN;

  $('vPrincipal').textContent=twd(P);
  $('vLoan').textContent=twd(L);
  $('vTotal').textContent=twd(total);
  $('vRate').textContent=r.toFixed(2)+'%';
  $('vMonthlyDiv').textContent=twd(mDiv);
  $('vMonthlyInt').textContent=twd(mInt);
  const netEl=$('vMonthlyNet'); netEl.textContent=twd(mNet); netEl.classList.toggle('pos',mNet>=0); netEl.classList.toggle('neg',mNet<0);
  $('vEstReturn').textContent=isFinite(estReturnPct)?(estReturnPct*100).toFixed(2)+'%':'—';
  $('vRatio').textContent=ratioObj?(ratioObj.ratio*100).toFixed(0)+'%':'自訂';

  $('loanRateMirror').value=(parseFloat(loanRateEl.value)||0).toFixed(2);
  if(typeof recomputePortfolio==='function') recomputePortfolio();
}
['input','change'].forEach(evt=>{
  [principalEl,loanEl,rateEl,loanRateEl,ratioEl].forEach(el=>el.addEventListener(evt,computeCashflow,{passive:true}));
});

/* ========= 匯出 ========= */
async function exportCurrent(type='png'){
  document.body.classList.add('exporting'); await new Promise(r=>setTimeout(r,0));
  const panel=document.querySelector('.tabpanel.active');
  const canvas=await html2canvas(panel,{backgroundColor:'#0A1221',scale:2,useCORS:true});
  document.body.classList.remove('exporting');
  if(type==='png'){const a=document.createElement('a'); a.download=(panel.id==='panel-cash'?'配息試算':'投組年化')+'.png'; a.href=canvas.toDataURL('image/png'); a.click();}
  else{ const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'pt',format:'a4'}); const w=pdf.internal.pageSize.getWidth(); const imgW=w; const imgH=canvas.height*(imgW/canvas.width); pdf.addImage(canvas.toDataURL('image/jpeg',0.95),'JPEG',0,20,imgW,imgH); pdf.save((panel.id==='panel-cash'?'配息試算':'投組年化')+'.pdf'); }
}
$('btnPng').addEventListener('click',()=>exportCurrent('png'));
$('btnPdf').addEventListener('click',()=>exportCurrent('pdf'));

/* ========= 綁定與啟動 ========= */
function bindInputs(){
  document.querySelectorAll('#fundInputTable .control').forEach(el=>{
    el.addEventListener('input',recomputePortfolio,{passive:true});
    el.addEventListener('change',recomputePortfolio,{passive:true});
  });
}
$('applyPresetBtn').addEventListener('click',()=>{
  const idx=$('presetSelect').value; if(idx==='') return alert('請先選擇常用基金');
  const row=parseInt($('targetRow').value,10)||0; applyPresetToRow(row,idx);
});

(function init(){
  loadCatalog();
  bindInputs();
  recomputePortfolio();
  computeCashflow();
})();
</script>
</body>
</html>
